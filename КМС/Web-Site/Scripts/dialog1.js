let knowledge = [
    [
        "Идеализированная модель реальных газов",
        "рассматривается",
        "в молекулярно-кинетической теории.",
    ],
    ["Идеальный газ", "рассматривается", "в молекулярно-кинетической теории."],
    [
        "Идеальный газ",
        "называется",
        "газ, между молекулами которого отсутствуют силы взаимного притяжения.",
    ],
    ["Молекулы идеального газа", "ведут", "себя как абсолютно упругие шарики."],
    ["Молекулы идеального газа", "движутся", "равномерно и прямолинейно."],
    [
        "Состояние газа",
        "определяется",
        "тремя термодинамическими параметрами: давлением p, объемом V и температурой T.",
    ],
    ["Уравнение", "называется", "уравнением состояния."],
    ["Простое уравнение", "является", "уравнением состояния для идеального газа"],
    ["Уравнение состояния", "называется", "уравнением Менделеева – Клапейрона."],
    [
        "Уравнение состояния",
        "выражается",
        "как <div class='formula'><span class='variable'>P</span><span class='operator'>⋅</span><span class='variable'>V</span><span class='operator'>=</span><span class='variable'>n</span><span class='operator'>⋅</span><span class='variable'>R</span><span class='operator'>⋅</span><span class='variable'>T</span></div>",
    ],
    // 11
    [
        "Молекулы идеального газа",
        "выглядят",
        "следующим образом: <img src='../img/screens/1_2.jpg' class='img-to-scale' alt='' />",
    ],
    [
        "Поступательное движение молекулы",
        "разлагается",
        "на три независимые составляющие движения вдоль осей декартовой системы координат.",
    ],
    ["Число независимых движений", "называется", "числом степеней свободы молекулы."],
    ["Число независимых движений", "обозначается", "i."],
    [
        "Число степеней свободы",
        "равняется",
        "числу независимых параметров, необходимых для определения положения молекулы в пространстве.",
    ],
    ["Молекулу одноатомного идеального газа", "можно рассматривать", "как материальную точку."],
    [
        "Положение в пространстве молекулы одноатомного идеального газа",
        "определяется",
        "тремя декартовыми координатами - х, у, z и, следовательно, она имеет три степени свободы.",
    ],
    [
        "Иллюстрация степеней свободы",
        "выглядит",
        "следующим образом: <img src='../img/screens/2_1.png' class='img-to-scale' alt='' />",
    ],
    [
        "Молекула двухатомного газа",
        "участвует",
        "во вращательном движении, помимо поступательного.",
    ],
    [
        "Иллюстрация молекулы 6 степеней свободы",
        "выглядит",
        "следующим образом: <img src='../img/screens/2_2.jpg' class='img-to-scale' alt='' />",
    ],
    //21
    [
        "Внутренняя энергия U идеального газа",
        "включает",
        "только кинетическую энергию поступательного и вращательного движений всех его молекул.",
    ],
    ["Потенциальная энергия взаимодействия молекул идеального газа", "равняется", "нулю."],
    ["Величина и направление скорости", "изменяются", "случайным образом."],
    ["Кинетическая энергия молекулы", "изменяется", "случайным образом."],
    [
        "Средняя кинетическая энергия",
        "является",
        "величиной постоянной, прямо пропорциональной абсолютной температуре газа T.",
    ],
    ["Все степени свободы равноправными", "являются", "в идеальном газе."],
    [
        "На каждую степень свободы",
        "приходится",
        "кинетическая энергия, пропорциональная коэффициенту теплоемкости, взятому из таблицы значений",
    ],
    ["Закон равного распределения энергии", "носит", "утверждение."],
    [
        "Внутренняя энергия",
        "выражается",
        "следующей формулой: <div class='formula'><span class='variable'>U</span><span class='operator'>=</span><span class='variable'>i</span><span class='variable'>N</span><span class='variable'>k</span><span class='variable'>T</span><span class='operator'>/</span><span class='variable'>2</span><span class='operator'>=</span><span class='variable'>i</span><span class='variable'>ν</span><span class='variable'>N</span><span class='subscript'>a</span><span class='variable'>k</span><span class='variable'>T</span><span class='operator'>/</span><span class='variable'>2</span><span class='operator'>=</span><span class='variable'>i</span><span class='variable'>ν</span><span class='variable'>R</span><span class='variable'>T</span><span class='operator'>/</span><span class='variable'>2</span></div>",
    ],
    ["Среднюю кинетическую энергию молекулы", "можно найти", "через потенциальную энергию"],
    // 31
    [
        "Соотношение постоянной Авогадро и коэффициента теплоемкости",
        "связывает",
        "важнейшие постоянные молекулярной физики.",
    ],
    ["Внутренняя энергия идеального газа", "зависит", "только от температуры."],
    [
        "Изменение внутренней энергии",
        "выражается",
        "как: <div class='formula'><span class='variable'>d</span><span class='variable'>U</span><span class='operator'>=</span><span class='variable'>- i/</span><span class='variable'>2</span><span class='variable'>ν</span><span class='variable'>R</span><span class='variable'>d</span><span class='variable'>T</span></div>",
    ],
    [
        "Информацию о внутренней энергии",
        "иллюстрируют",
        "следующим образом: <img src='../img/screens/3_1.jpg' class='img-to-scale' alt='' />",
    ],
    ["Подводимое к газу количество теплоты", "идет", "на изменение его внутренней энергии."],
    [
        "Подводимое к газу количество теплоты",
        "идет",
        "на совершение газом работы против внешних сил.",
    ],
    [
        "Подводимое к газу количество теплоты",
        "выражается",
        "следующей формулой: <div class='formula'><span class='variable'>δ</span><span class='variable'>Q</span><span class='operator'>=</span><span class='variable'>Δ</span><span class='variable'>U</span><span class='operator'>+</span><span class='variable'>δ</span><span class='variable'>A</span></div>",
    ],
    [
        "Элементарная работа",
        "рассчитывается",
        "по формуле: <div class='formula'><span class='variable'>δ</span><span class='variable'>A</span><span class='operator'>=</span><span class='variable'>p</span><span class='variable'>d</span><span class='variable'>V</span></div>",
    ],
    ["Количество теплоты", "прямо зависит", "от массы m газа."],
    ["Количество теплоты", "прямо зависит", "от изменения его температуры."],
    // 41
    [
        "Количество теплоты",
        "выражается",
        "следующей формулой: <div class='formula'><span class='variable'>δ</span><span class='variable'>Q</span><span class='operator'>=</span><span class='variable'>c</span><span class='variable'>m</span><span class='variable'>d</span><span class='variable'>T</span><span class='operator'>=</span><span class='variable'>C</span><span class='variable'>v</span><span class='variable'>d</span><span class='variable'>T</span></div>",
    ],
    ["Величина с", "называется", "удельной теплоемкостью."],
    ["Величина С = сm", "называется", "молярной - С теплоемкостью."],
    [
        "Теплоемкость",
        "определяется",
        "количеством теплоты, необходимым для повышения температуры на 1 кельвин.",
    ],
    [
        "Величина C",
        "определяется",
        "количеством теплоты, необходимым для повышения температуры одного моля вещества на 1 кельвин.",
    ],
    ["Теплоемкость газа", "зависит", "от характера процесса."],
    [
        "Газовые процессы",
        "играют",
        "важную роль, при которых изменяются только два термодинамических параметра.",
    ],
    [
        "Первое начало термодинамики",
        "можно",
        "иллюстрировать следующим образом: <img src='../img/screens/4_1.jpg' class='img-to-scale' alt='' />",
    ],
    ["Изотермический процесс", "определяется", "тем, что температура газа остается постоянной"],
    ["Уравнение изотермического процесса", "соответствует", "закону Бойля – Мариотта."],
    ["Закон Бойля – Мариотта", "формулирует", " постоянство давления и обьема"],
    // 52
    ["Внутренняя энергия газа", "не изменяется", "при изотермическом процессе."],
    [
        "Первое начало термодинамики",
        "принимает",
        "вид <div class='formula'><span class='variable'>δ</span><span class='variable'>Q</span><span class='operator'>=</span><span class='variable'>δ</span><span class='variable'>A</span></div>",
    ],
    ["Подводимое тепло", "идет", "полностью на совершение работы газом."],
    [
        "Закон Бойля – Мариотта",
        "можно",
        "иллюстрировать следующим образом: <img src='../img/screens/5_1.jfif' class='img-to-scale' alt='' />",
    ],
    ["Изохорический процесс", "является", "процессом, протекающим при неизменном объеме"],
    [
        "Уравнение изохорического процесса",
        "имеет",
        "вид: <div class='formula'><span class='variable'>p</span><span class='variable'>T</span><span class='operator'>=</span><span class='variable'>const</span></div>",
    ],
    ["Газ", "не совершает", "работы при изохорическом процессе."],
    [
        "Первое начало термодинамики",
        "принимает",
        "вид <div class='formula'><span class='variable'>δ</span><span class='variable'>Q</span><span class='operator'>=</span><span class='variable'>d</span><span class='variable'>U</span></div>",
    ],
    // 61
    ["Подводимая к газу теплота", "идет", "на изменение его внутренней энергии."],
    [
        "Подводимая к газу теплота",
        "выражается",
        "как <div class='formula'><span class='variable'>C</span><span class='subscript'>v</span><span class='operator'>=</span><span class='variable'>- i/</span><span class='variable'>2</span><span class='variable'>- R/</span><span class='variable'>M</span></div>",
    ],
    [
        "Изохорный процесс",
        "можно",
        "иллюстрировать следующим образом: <img src='../img/screens/5_2.jpg' class='img-to-scale' alt='' />",
    ],
    ["Изобарический процесс", "является", "процессом, протекающим при постоянном давлении."],
    [
        "Уравнение изобарического процесса",
        "имеет",
        "вид: <div class='formula'><span class='variable'>V / </span><span class='variable'>T</span><span class='operator'>=</span><span class='variable'>const</span></div>",
    ],
    [
        "Закон Гей − Люссака",
        "имеет",
        "вид: <div class='formula'><span class='variable'>V / </span><span class='variable'>T</span><span class='operator'>=</span><span class='variable'>const</span></div>",
    ],
    ["При изобарическом процессе", "подводимая теплота", "идет на увеличение внутренней энергии."],
    ["При изобарическом процессе", "подводимая теплота", "идет на совершение газом работы."],
    [
        "Работа в изобарическом процессе",
        "имеет",
        "вид: <div class='formula'><span class='variable'>δ</span><span class='variable'>A</span><span class='operator'>=</span><span class='variable'>p</span><span class='variable'>d</span><span class='variable'>V</span><span class='operator'>=</span><span class='variable'>d</span><span class='operator'>- </span><span class='variable'>p</span><span class='variable'>V</span><span class='operator'></span><span class='operator'>=</span><span class='variable'>ν</span><span class='variable'>R</span><span class='variable'>d</span><span class='variable'>T</span></div>",
    ],
    [
        "Формула работы в изобарическом процессе",
        "получается",
        "если взять дифференциал от правой и левой частей уравнения.",
    ],
    [
        "Удельная теплоемкость в изобарическом процессе",
        "имеет",
        "вид: <div class='formula'><span class='variable'>C</span><span class='subscript'>p</span><span class='operator'>=</span><span class='variable'>- i+</span><span class='variable'>2/</span><span class='variable'>2</span><span class='variable'>R/</span><span class='variable'>M</span></div>",
    ],
    // 71
    [
        "Удельная теплоемкость в изобарическом процессе",
        "имеет",
        "вид: <div class='formula'><span class='variable'>C</span><span class='subscript'>p</span><span class='operator'>=</span><span class='variable'>- i+</span><span class='variable'>2</span><span class='operator'>/</span><span class='variable'>2</span><span class='variable'>R</span></div>",
    ],
    [
        "Теплоемкости при изобарическом и изохорическом процессах",
        "связываются",
        "соотношением, которое называется уравнением Майера.",
    ],
    [
        "Уравнение Майера",
        "имеет",
        "вид: <div class='formula'><span class='variable'>C</span><span class='subscript'>v</span><span class='operator'>+</span><span class='variable'>R</span><span class='operator'>=</span><span class='variable'>C</span><span class='subscript'>p</span></div>",
    ],
    ["Первое начало термодинамики", "происходит", "в условиях адиабатического процесса."],
    [
        "Изопроцессы",
        "можно иллюстрировать",
        "следующим образом: <img src='../img/screens/5_3.png' class='img-to-scale' alt='' />",
    ],
    [
        "Адиабатический процесс",
        "является",
        "процессом, при котором теплота к газу не подводится и не отводится.",
    ],
    [
        "Адиабатический процесс",
        "является",
        "процессом, который протекает без теплообмена системы с окружающей средой.",
    ],
    ["Первое начало термодинамики", "представляется", "в условиях адиабатического процесса."],
    [
        "Газ",
        "совершает",
        "работу только за счет убыли внутренней энергии при адиабатическом процессе.",
    ],
    // 80
    [
        "Из уравнения Менделеева − Клапейрона",
        "можно получить",
        "уравнение адиабатического процесса - уравнение Пуассона",
    ],
    [
        "Уравнение Пуассона",
        "имеет",
        "вид: <div class='formula'><span class='variable'>p</span><span class='variable'>V</span><span class='superscript'>γ</span><span class='operator'>=</span><span class='variable'>const</span></div>",
    ],
    ["Величина γ", "называется", "показателем адиабаты."],
    ["Величина γ", "называется", "адиабатической постоянной."],
    ["Величина γ", "равняется", "отношению теплоемкостей."],
    ["Показатель адиабаты", "равняется", "отношению теплоемкостей."],
    ["Адиабатическая постоянная", "равняется", "отношению теплоемкостей."],
    [
        "Адиабатическая постоянная",
        "выражается",
        "формулой: <div class='formula'><span class='variable'>γ</span><span class='operator'>=</span><span class='variable'>C</span><span class='subscript'>p</span><span class='operator'>/</span><span class='variable'>C</span><span class='subscript'>v</span><span class='operator'>=</span><span class='variable'>- i+</span><span class='variable'>2</span><span class='operator'>/</span><span class='variable'>i</span></div>",
    ],
    [
        "Величина γ ",
        "выражается",
        "формулой: <div class='formula'><span class='variable'>γ</span><span class='operator'>=</span><span class='variable'>C</span><span class='subscript'>p</span><span class='operator'>/</span><span class='variable'>C</span><span class='subscript'>v</span><span class='operator'>=</span><span class='variable'>- i+</span><span class='variable'>2</span><span class='operator'>/</span><span class='variable'>i</span></div>",
    ],
    [
        "Показатель адиабаты ",
        "выражается",
        "формулой: <div class='formula'><span class='variable'>γ</span><span class='operator'>=</span><span class='variable'>C</span><span class='subscript'>p</span><span class='operator'>/</span><span class='variable'>C</span><span class='subscript'>v</span><span class='operator'>=</span><span class='variable'>- i+</span><span class='variable'>2</span><span class='operator'>/</span><span class='variable'>i</span></div>",
    ],
    // 100
    [
        "Адиабатный процесс",
        "можно",
        "иллюстрировать следующим образом: <img src='../img/screens/5_4.jpg' class='img-to-scale' alt='' />",
    ],
    ["Величина М", "является", "количеством вещества"],
    ["Величина М", "является", "числом молей газа"],
    ["Установка", "состоит", "из стеклянного баллона"],
    ["Установка", "состоит", "из водяного манометра"],
    ["Установка", "состоит", "из воздушного насоса"],
    ["Установка", "состоит", "из крана"],
    ["Установка", "состоит", "из пробки"],
    [
        "Первым действием работы с установкой",
        "является",
        "нажать на пробку, тем самым закрыв доступ из атмосферы.",
    ],
    [
        "Вторым действием работы с установкой",
        "является",
        "нажать на краник слева от манометра, чтобы мы могли качать воздух.",
    ],
    // 111
    [
        "Третьим действием работы с установкой",
        "является",
        "нажать на насос, начнется накачивание воздуха в баллон, тем самым уровень воды изменится и замерим ее разницу.",
    ],
    [
        "Четвертым действием работы с установкой",
        "является",
        "нажать на пробку, она ненадолго выйдет и зайдет обратно, тем самым дав атмосфере изменить давление, что сможем наблюдать на уровне воды.",
    ],
    [
        "Пятым действием работы с установкой",
        "является",
        "вытащить пробку и вернуть установку в обычное состояние.",
    ],
];

let endings = [
    ["ет", "(ет|ут|ют)"],
    ["ут", "(ет|ут|ют)"],
    ["ют", "(ет|ут|ют)"],

    ["ит", "(ит|ат|ят)"],
    ["ат", "(ит|ат|ят)"],
    ["ят", "(ит|ат|ят)"],

    ["ется", "(ет|ут|ют)ся"],
    ["утся", "(ет|ут|ют|ующие)ся"],
    ["ются", "(ет|ут|ют)ся"], //1 спряжение, возвратные

    ["ится", "(ит|ат|ят)ся"],
    ["атся", "(ит|ат|ят)ся"],
    ["ятся", "(ит|ат|ят)ся"], //2 спряжение, возвратные

    ["ящие", "ящие"],
    ["ee", "ee"],
    ["ен", "ен"],
    ["ую", "ую"],
    ["му", "му"],
    ["ма", "ма"],
    ["ена", "ена"],
    ["ено", "ено"],
    ["ены", "ены"],
    ["ан", "ан"],
    ["ая", "ая"],
    ["ана", "ана"],
    ["ано", "ано"],
    ["аны", "аны"], //краткие прилагательные
    ["но", "но"],
    ["на", "на"],
    ["жен", "жен"],
    ["жна", "жна"],
    ["жно", "жно"],
    ["жны", "жны"],
    ["такое", "- это"],
];

function escapeSpecialChars(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // Экранирование специальных символов
}

// поиск сказуемого по псевдоокончаниям
function getEnding(word) {
    for (let i = 0; i < endings.length; i++)
        // убираем, например -ет, -ут, -ют
        if (word.substring(word.length - endings[i][0].length) == endings[i][0]) {
            return i;
        }

    return -1;
}

function small(str) {
    return str.substring(0, 1).toLowerCase() + str.substring(1);
}

function big(str) {
    return str.substring(0, 1).toUpperCase() + str.substring(1);
}

function getAnswer(question) {
    question = escapeSpecialChars(question);
    let separators = "'\",.!?()[]\\/";

    //добавление пробелов перед знаками препинания
    for (let i = 0; i < separators.length; i++)
        question = question.replace(separators[i], " " + separators[i]);

    // приведем к нормальному виду
    let words = question.split(" ");

    for (let i = 0; i < words.length; i++) words[i] = small(words[i]);

    let result = false;
    let answer = "";

    // поиск по сказуемому
    for (let i = 0; i < words.length; i++) {
        let ending = getEnding(words[i]);

        // нашли сказуемое
        if (ending >= 0) {
            // заменить на слово с подходящим окончанием
            words[i] =
                words[i].substring(0, words[i].length - endings[ending][0].length) +
                endings[ending][1];

            // варинаты спряжений теперь доступны: "(ет|ут|ют)"
            let predicate = new RegExp(".*" + words[i] + ".*");

            // для кратких прилагательных без изменений
            if (endings[ending][0] == endings[ending][1]) {
                predicate = new RegExp(".*" + words[i] + " " + words[i + 1] + ".*");
                i++;
            }

            //создание регулярного выражения для поиска по подлежащему из вопроса
            let subjectReg = words.slice(i + 1).join(".*");

            if (subjectReg.length > 0) {
                // сможем выбрать подлежащее после сказуемого
                let subject = new RegExp(".*" + subjectReg + ".*");

                //поиск по 1 и 3 столбцу подлежащего, если они переставлены
                for (let j = 0; j < knowledge.length; j++) {
                    // console.log(subject.test(knowledge[j][2]));
                    // console.log(knowledge[j][2]);

                    if (
                        predicate.test(knowledge[j][1].toLowerCase()) &&
                        (subject.test(knowledge[j][0].toLowerCase()) ||
                            subject.test(knowledge[j][2].toLowerCase()))
                    ) {
                        // кладем в ответ
                        answer += big(
                            knowledge[j][0] + " " + knowledge[j][1] + " " + knowledge[j][2] + " . "
                        );
                        result = true;
                    }
                }

                if (!result) {
                    //поиск совпадений только с шаблоном подлежащего
                    for (let j = 0; j < knowledge.length; j++) {
                        if (
                            subject.test(
                                knowledge[j][0].toLowerCase() ||
                                    subject.test(knowledge[j][2].toLowerCase())
                            )
                        ) {
                            answer += big(
                                knowledge[j][0] + " " + knowledge[j][1] + " " + knowledge[j][2]
                            );
                            result = true;
                            break;
                        }
                    }
                }
            }
        }
    }

    if (!result) answer = "Ответ не найден";
    return answer;
}

var dialogOn = false;

function toggleDialog() {
    dialogOn = !dialogOn;
    $("#dialog").animate({ top: dialogOn ? "0" : "91%", bottom: dialogOn ? "0" : "unset" }, 600);
}

function prepare_environment() {
    document.body.innerHTML += "<div class='overlay' onclick='toggleDialog()'></div>";
    document.body.innerHTML += `<div id='dialog' class='dialog'>
      <img src="../img/arrow-expand.svg" width="32" height="32" onclick='toggleDialog()' class="close-btn" />
      <div class='dialog-content'>
            <div class='header' onclick='toggleDialog()'>Задайте вопрос!</div>
            <div class='history' id='history'></div>
            <div class='question'>
                <input id='Qdialog' placeholder='Введите вопрос' onKeyDown='if(event.keyCode==13)ask(&quot;Qdialog&quot;)'/>
                <br>
                <button onclick='ask(&quot;Qdialog&quot;)'>Получить ответ</button>
            </div>
      </div>
    </div>`;
}

window.onload = function () {
    prepare_environment();
};

function ask(questionInput) {
    var question = document.getElementById(questionInput).value.trim();
    if (question === "") return;

    var newDiv = document.createElement("div");
    newDiv.className = "question";
    newDiv.innerHTML = question;
    document.getElementById("history").appendChild(newDiv);

    newDiv = document.createElement("div");
    newDiv.className = "answer";
    var answer = getAnswer(question);

    if (answer.includes("<img")) {
        let formattedAnswer = answer.slice(0, -2);
        newDiv.innerHTML = formattedAnswer;
    } else {
        newDiv.innerHTML = answer;
    }

    if (newDiv.innerHTML.includes("<img")) {
        newDiv.innerHTML += `<img src="../img/zoom.svg" width="16" height="16" onclick='zoom(this.src)' class="zoom-img" style='max-width: 100%; cursor: pointer;'/>`;

        const splitted = answer.split("<img");
        let func = `onclick="changeScale"`;
        answer = splitted[0] + "<img" + " " + func + splitted[1];

        console.log(answer);
    }

    document.getElementById("history").appendChild(newDiv);
    document.getElementById("history").scrollTop = document.getElementById("history").scrollHeight;
    document.getElementById(questionInput).value = "";
}

function zoom(src) {
    const newImg = document.createElement("img");
    newImg.src = src;
    newImg.id = "img-current-popup";

    newImg.style.position = "fixed";
    newImg.style.top = "20%";
    newImg.style.left = "20%";
    newImg.style.zIndex = "10000";

    document.body.appendChild(newImg);
}

function closeZoom() {
    const currentPopup = document.getElementById("img-current-popup");
    if (currentPopup) {
        currentPopup.remove();
    }
}

function changeScale(e) {
    e.target.style.transform = "scale(2)";
}

window.addEventListener("click", (e) => {
    const currentPopup = document.getElementById("img-current-popup");

    if (e.target.id === "img-current-popup") {
        closeZoom();
    }

    if (e.target.classList.contains("img-to-scale") && !currentPopup) {
        zoom(e.target.src);
    }
});
